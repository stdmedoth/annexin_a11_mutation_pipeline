#!/usr/bin/env python3
"""
Conformational Analysis Script

Analyzes conformational ensembles generated by BioEmu.

Usage:
    python scripts/analyze_conformations.py --input data/outputs/protein/A123G
"""

import sys
import argparse
from pathlib import Path
import json
import numpy as np

# Add src to path
SCRIPT_DIR = Path(__file__).resolve().parent
PROJECT_ROOT = SCRIPT_DIR.parent
sys.path.insert(0, str(PROJECT_ROOT))

from src.analysis import (
    ConformationalAnalyzer,
    ComparativeAnalyzer,
    AnalysisConfig,
    create_analysis_plots
)


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Analyze conformational ensembles from BioEmu"
    )
    parser.add_argument(
        "--input", "-i",
        type=Path,
        required=True,
        help="Input directory containing wt/ and mutant/ subdirectories"
    )
    parser.add_argument(
        "--output", "-o",
        type=Path,
        default=None,
        help="Output directory for analysis results (default: input/analysis)"
    )
    parser.add_argument(
        "--pca-components",
        type=int,
        default=10,
        help="Number of PCA components to compute"
    )
    parser.add_argument(
        "--contact-cutoff",
        type=float,
        default=8.0,
        help="Distance cutoff for contact maps (Angstroms)"
    )
    parser.add_argument(
        "--plots",
        action="store_true",
        help="Generate visualization plots"
    )
    
    return parser.parse_args()


def load_trajectory_from_aligned(aligned_dir: Path) -> np.ndarray:
    """
    Load aligned trajectory from numpy file or PDB files.
    
    Args:
        aligned_dir: Directory containing aligned structures
        
    Returns:
        Trajectory array (n_frames x n_atoms x 3)
    """
    # Try to load from numpy file first
    npy_file = aligned_dir / "aligned_trajectory.npy"
    if npy_file.exists():
        return np.load(npy_file)
    
    # Otherwise, try to load PDB files with MDTraj
    try:
        import mdtraj as md
        
        pdb_files = sorted(aligned_dir.glob("aligned_conf_*.pdb"))
        if not pdb_files:
            raise FileNotFoundError(f"No PDB files found in {aligned_dir}")
        
        trajectories = [md.load(str(f)) for f in pdb_files]
        combined = md.join(trajectories)
        
        # Return coordinates in Angstroms
        return combined.xyz * 10  # nm to Angstroms
        
    except ImportError:
        raise ImportError("MDTraj is required to load PDB files")


def main():
    """Main analysis function."""
    args = parse_args()
    
    input_dir = args.input.resolve()
    output_dir = args.output or (input_dir / "analysis")
    output_dir.mkdir(parents=True, exist_ok=True)
    
    print(f"Input directory: {input_dir}")
    print(f"Output directory: {output_dir}")
    print()
    
    # Configure analysis
    config = AnalysisConfig(
        pca_components=args.pca_components,
        contact_cutoff=args.contact_cutoff
    )
    
    analyzer = ConformationalAnalyzer(config)
    comparative = ComparativeAnalyzer()
    
    results = {}
    
    # Analyze each variant
    for variant in ['wt', 'mutant']:
        aligned_dir = input_dir / variant / "aligned"
        
        if not aligned_dir.exists():
            print(f"⚠ Skipping {variant}: aligned directory not found")
            continue
        
        print(f"Analyzing {variant.upper()} conformations...")
        
        try:
            trajectory = load_trajectory_from_aligned(aligned_dir)
            print(f"  Loaded {trajectory.shape[0]} frames, {trajectory.shape[1]} atoms")
            
            variant_output = output_dir / variant
            variant_output.mkdir(exist_ok=True)
            
            results[variant] = analyzer.full_analysis(trajectory, variant_output)
            
            print(f"  Rg: {results[variant]['rg']['mean']:.2f} ± {results[variant]['rg']['std']:.2f} Å")
            
            if 'pca' in results[variant]:
                var_explained = results[variant]['pca']['cumulative_variance']
                pc3_var = var_explained[2] if len(var_explained) >= 3 else var_explained[-1]
                print(f"  PCA: First 3 PCs explain {pc3_var * 100:.1f}% variance")
            
            # Generate plots
            if args.plots:
                print(f"  Generating plots...")
                plot_paths = create_analysis_plots(results[variant], variant_output)
                print(f"  Created {len(plot_paths)} plots")
            
        except Exception as e:
            print(f"  ✗ Error analyzing {variant}: {e}")
    
    # Comparative analysis if both variants available
    if 'wt' in results and 'mutant' in results:
        print()
        print("Performing comparative analysis...")
        
        comparison_output = output_dir / "comparison"
        comparison_output.mkdir(exist_ok=True)
        
        # Calculate differences
        comparison = {
            "rg_difference": {
                "wt_mean": results['wt']['rg']['mean'],
                "mutant_mean": results['mutant']['rg']['mean'],
                "delta": results['mutant']['rg']['mean'] - results['wt']['rg']['mean'],
            }
        }
        
        with open(comparison_output / "comparison.json", 'w') as f:
            json.dump(comparison, f, indent=2)
        
        print(f"  ΔRg: {comparison['rg_difference']['delta']:+.2f} Å")
        print(f"  Comparison results saved to {comparison_output}")
    
    print()
    print("✓ Analysis complete!")
    print(f"  Results saved to: {output_dir}")


if __name__ == "__main__":
    main()
